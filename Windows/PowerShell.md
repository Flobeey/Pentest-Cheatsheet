# PowerShell

```powershell
# Basic navigation
Get-Location
Get-ChildItem
Set-Location .\Documents\
Get-Content Readme.md
Get-Command
Get-Command -noun windows* # specific command
Get-History
get-content C:\Users\DLarusso\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadLine\ConsoleHost_history.txt # get a specific user's history
Get-Alias
Set-Alias -Name gh -Value Get-Help

# Modules
Get-Module
Get-Module -ListAvailable
Import-Module .\PowerSploit.psd1
Get-Command -Module PowerSploit

# Execution policy
Get-ExecutionPolicy
Set-ExecutionPolicy undefined
Set-ExecutionPolicy -scope Process
Get-ExecutionPolicy -list

# Local users and groups
Get-LocalUser
Get-LocalUser | Measure-Object # number of local users
New-LocalUser -Name "JLawrence" -NoPassword
$Password = Read-Host -AsSecureString
Set-LocalUser -Name "JLawrence" -Password $Password -Description "CEO EagleFang"
Get-Localgroup 
AddLocalGroupMember -Group "Remote Desktop Users" -Member "JLawrence"
GetLocalGroupMember -Name "Remote Desktop Users"

# Domain users and groups
Get-WindowsCapability -Name RSAT* -Online | Add-WindowsCapability -Online
Get-Module -Name ActiveDirectory -ListAvailable
Get-ADUser -Filter *
Get-ADUser -Identity TSilver - Property *
Get-ADUser -Filter {EmailAddress -like '*greenhorn.corp'}
New-ADUser -Name "MTanaka" -Surname "Tanaka" -GivenName "Mori" -Office "Security" -OtherAttributes @{'title'="Sensei";'mail'="MTanaka@greenhorn.corp"} -Accountpassword (Read-Host -AsSecureString "AccountPassword") -Enabled $true # add user
Set-ADUser -Identity MTanaka -Description "New description"

# Files and directories
New-Item -Name "SOPs" -Type directory
New-Item "Readme.md" -ItemType File
Add-Content .\Readme.md "Title: Insert Document Title Here"
Rename-Item .\Cyber-Sec-draft.md -NewName Infosec-SOP-draft.md
Get-ChildItem -Path *.txt | Rename-Item -NewName {$_.name -replace ".txt",".md"} # change txt files to md

# Object manipulation
Get-LocalUser administrator | get-member # get properties / methods
Get-LocalUser administrator | Select-Object -Property * # get properties
Get-LocalUser * | Select-Object -Property Name,PasswordLastSet # filter
Get-LocalUser * | Sort-Object -Property Name | Group-Object -property Enabled # sort and group
get-service | Select-Object -Property DisplayName,Name,Status | Sort-Object DisplayName | fl # example
Get-Service | where DisplayName -like '*Defender*' # search
get-process | sort | unique | measure-object # count unique instances
Get-Content '.\test.txt' && ping 8.8.8.8 # successful pipeline
Get-Content '.\testss.txt' || ping 8.8.8.8 # error pipeline

# Finding files
Get-ChildItem -Path C:\Users\MTanaka\ -File -Recurse
Get-Childitem –Path C:\Users\MTanaka\ -File -Recurse -ErrorAction SilentlyContinue | where {($_.Name -like "*.txt")} # Based on format
Get-Childitem –Path C:\Users\MTanaka\ -File -Recurse -ErrorAction SilentlyContinue | where {($_.Name -like "*.txt" -or $_.Name -like "*.py")} # extension
PS C:\htb> Get-Childitem –Path C:\Users\MTanaka\ -File -Recurse -ErrorAction SilentlyContinue | where {($_.Name -like "*.txt" -or $_.Name -like "*.py" -or $_.Name -like "*.ps1" -or $_.Name -like "*.md" -or $_.Name -like "*.csv")} # big list
Get-ChildItem -Path C:\Users\MTanaka\ -Filter "*.txt" -Recurse -File | sls "Password","credential","key" # basic query (sls => select-string)
Get-Childitem –Path C:\Users\MTanaka\ -File -Recurse -ErrorAction SilentlyContinue | where {($_. Name -like "*.txt" -or $_. Name -like "*.py" -or $_. Name -like "*.ps1" -or $_. Name -like "*.md" -or $_. Name -like "*.csv")} | sls "Password","credential","key","UserName" # combined search
get-childitem -file -recurse | Sort-Object LastWriteTime | select-object -first 10 # Find recently modified files

# Services
Get-Help *-Service
Get-Service | ft DisplayName,Status
Get-Service | where DisplayName -like '*Defender*' | ft DisplayName,ServiceName,Status # details about Defender
Start-Service WinDefend
Stop-Service WinDefend
Get-Service spooler | Select-Object -Property Name, StartType, Status, DisplayName
Set-Service -Name Spooler -StartType Disabled
Get-Service -ComputerName ACADEMY-ICL-DC # remote
Get-Service -ComputerName ACADEMY-ICL-DC | Where-Object {$_.Status -eq "Running"} # remote with filtering
Invoke-Command -ComputerName ACADEMY-ICL-DC,LOCALHOST -ScriptBlock {Get-Service -Name 'windefend'} # invoke remote command

# Windows Registry
Get-ChildItem C:\Windows\System32\config\
Get-Item -Path Registry::HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Run | Select-Object -ExpandProperty Property # get keys
Get-ChildItem -Path HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion -Recurse # get keys with recursion
Get-ItemProperty -Path Registry::HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Run # get key property
New-Item -Path HKCU:\SOFTWARE\Microsoft\Windows\CurrentVersion\RunOnce\ -Name TestKey # new key
New-ItemProperty -Path HKCU:\SOFTWARE\Microsoft\Windows\CurrentVersion\RunOnce\TestKey -Name  "access" -PropertyType String -Value "C:\Users\htb-student\Downloads\payload.exe" # new key property
Remove-ItemProperty -Path HKCU:\SOFTWARE\Microsoft\Windows\CurrentVersion\RunOnce\TestKey -Name  "access" # delete key

# Windows Event Log
Get-WinEvent -ListLog *
Get-WinEvent -ListLog Security
Get-WinEvent -LogName 'Security' -MaxEvents 5 | Select-Object -ExpandProperty Message
Get-WinEvent -FilterHashTable @{LogName='Security';ID='4625 '}
Get-WinEvent -FilterHashTable @{LogName='System';Level='1'} | select-object -ExpandProperty Message

Get-WinEvent -FilterHashtable @{LogName='Security'; ID=4625} | select-object -ExpandProperty Message | Select-String -Pattern 'Account Name: (\w+)' | ForEach-Object { $_.Matches.Groups[1].Value }



# Network
ipconfig /all
netstat -an
netstat -naob # list network connections
Get-netIPInterface
Get-NetIPAddress -ifIndex 25
Set-NetIPInterface -InterfaceIndex 25 -Dhcp Disabled
Set-NetIPAddress -InterfaceIndex 25 -IPAddress 10.10.100.54 -PrefixLength 24
Get-NetIPAddress -ifindex 20 | ft InterfaceIndex,InterfaceAlias,IPAddress,PrefixLength
Restart-NetAdapter -Name 'Ethernet 3'
Test-NetConnection

# Enable remote tools
Add-WindowsCapability -Online -Name OpenSSH.Client~~~~0.0.1.0.
Add-WindowsCapability -Online -Name OpenSSH.Server~~~~0.0.1.0
Start-Service sshd # SSH
winrm quickconfig # WinRM
Test-WSMan -ComputerName "10.129.224.248"
Test-WSMan -ComputerName "10.129.224.248" -Authentication Negotiate
Enter-PSSession -ComputerName 10.129.224.248 -Credential htb-student -Authentication Negotiate # enter remote session

# Interact with the web
Invoke-WebRequest -Uri "https://web.ics.purdue.edu/.../05_simple.html" -Method GET | fl RawContent
Invoke-WebRequest -Uri "https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1" -OutFile "C:\PowerView.ps1"
(New-Object Net.WebClient).DownloadFile("https://github.com/BloodHoundAD/BloodHound/releases/download/4.2.0/BloodHound-win32-x64.zip", "Bloodhound.zip")